{{- $k := .Values.hostSelectorLabel.key -}}
{{- $v := .Values.hostSelectorLabel.value -}}
apiVersion: projectcalico.org/v3
kind: GlobalNetworkPolicy
metadata:
  name: host-ingress-allowlist
spec:
  selector: {{ printf "%s == '%s'" $k $v | quote }}
  types:
    - Ingress

  # ðŸ”‘ CRITICAL FLAGS (this is what you were missing)
  preDNAT: true
  applyOnForward: true
  
  ingress:
    # 1) Allow ALL traffic from Kubernetes nodes
    - action: Allow
      source:
        nets:
{{- range .Values.allowAllFromNodeIPs }}
          - {{ . | quote }}
{{- end }}

    # 2) Allow SSH and portforward only from admin IPs
    - action: Allow
      protocol: TCP
      source:
        nets:
{{- range .Values.allowSSHFrom }}
          - {{ . | quote }}
{{- end }}
      destination:
        ports:
          - 22
          - 10250

    # 3) Allow 80, 443, 6443 only from trusted external IP
    - action: Allow
      protocol: TCP
      source:
        nets:
{{- range .Values.allowProxyLoaders }}
          - {{ . | quote }}
{{- end }}
      destination:
        ports:
          - 80
          - 443
          - 6443

    # 4) Allow pods to reach NodePorts (only the NodePort range)
    {{- $npMin := int .Values.nodePortRange.min -}}
    {{- $npMax := int .Values.nodePortRange.max -}}

    # Allow pods to reach NodePorts (TCP)
    - action: Allow
      protocol: TCP
      source:
        nets:
    {{- range .Values.podCidrs }}
          - {{ . | quote }}
    {{- end }}
      destination:
        ports:
          - {{ printf "%d:%d" $npMin $npMax | quote }}

    - action: Allow
      protocol: UDP
      source:
        nets:
    {{- range .Values.podCidrs }}
          - {{ . | quote }}
    {{- end }}
      destination:
        ports:
          - {{ printf "%d:%d" $npMin $npMax | quote }}

    # 5) DENY EVERYTHING ELSE
    - action: Deny
